<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Enkel 3D-applikasjon</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #paneDiv {
      position: absolute;
      top: 12px;
      left: 62px;
      width: 80%;
      padding: 0 12px 0 12px;
      background-color: rgba(255, 255, 255, 0.85);
      border: 1px solid white;
      color: black;
    }

    #resultsDiv {
      font-size: 1.2em;
      text-align: center;
      border-bottom: 1px solid gray;
      padding: 10px 0px;
    }

    #activeElevationLayerDiv {
      margin: 10px 0;
    }

    ul #red {
      color: rgb(150, 26, 15);
    }

    ul #green {
      color: rgb(21, 150, 15);
    }

    ul span {
      color: black;
    }

    ul {
      margin: 0 0 10px 0;
    }

    #hoydeinfo{
      position: absolute;
      color: white;
      font-family: sans-serif;
      size:1.3em;
      font-weight:bold;
      -webkit-text-stroke: .5px black;
      padding: 10px;
      overflow: hidden;
      background-color: none;
      top: 50px;
      left: 50px;
      margin: auto;
      display: flex;
      border-radius:10px;
      user-select:none;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
  <script src="https://js.arcgis.com/4.6/"></script>

  <script>
    require([
      "esri/Map",
      "esri/layers/TileLayer",
      "esri/layers/MapImageLayer",
      "esri/Basemap",
      "esri/layers/ElevationLayer",
      "esri/views/SceneView",
      "esri/widgets/Locate",
      "esri/Graphic",
      "esri/Viewpoint",
      "esri/geometry/Point",
      "esri/widgets/DirectLineMeasurement3D",
      "esri/widgets/Legend",
      "esri/request",
      "dojo/domReady!"

    ], function(
      Map, TileLayer, MapImageLayer, Basemap, ElevationLayer, SceneView,
      Locate, Graphic, Viewpoint, Point, DirectLineMeasurement3D, Legend, esriRequest
    ) {

      // Create elevation layers
      var bakke = new ElevationLayer({
        url: "https://services.geodataonline.no/arcgis/rest/services/Geocache_UTM33_EUREF89/GeocacheTerreng/ImageServer"
      });

      var bilder = new TileLayer({
          url: "https://services.geodataonline.no/arcgis/rest/services/Geocache_UTM33_EUREF89/GeocacheBilder/MapServer",
          id: "Bilder",
          visible: true
        });

      var bratthet = new MapImageLayer({
        url: "https://wms3.nve.no/map/rest/services/Bratthet/MapServer",
        sublayers: [
            {
              id: 0,
              visible: true,
              opacity: .5,
              legendEnabled: true,
            }
          ]
        });

      var skredHendelser = new MapImageLayer({
        url: "https://wms3.nve.no/map/rest/services/SkredHendelser/MapServer",
        sublayers: [
            {
              id: 1,
              visible: true,
              legendEnabled: true,
            }
          ]
        });

      console.log('Lag', bratthet, skredHendelser)



       var bilder = new Basemap({
         baseLayers: [bilder],
         title: "Bilder",
         id: "bilder"
       });

      // Create Map and View
      var map = new Map({
        basemap: bilder,
        ground: {
          layers: [bakke]
        }
      });

      var view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          // initial view:
          heading: 332.8,
          tilt: 30,
          position: {
            x: 564096,
            y: 7628465,
            z: 5000,
            spatialReference: {
              wkid: 25833
            }
          }
        }
      });

      view.map.addMany([bratthet, skredHendelser])
      console.log("Lag",view)

      var locateWidget = new Locate({
        view: view,   // Attaches the Locate button to the view
        graphic: new Graphic({
          symbol: { type: "simple-marker" }  // overwrites the default symbol used for the
          // graphic placed at the location of the user when found
        })
      });
      // var measureWidget = new DirectLineMeasurement3D({
      //   view: view
      // });



      view.when(function(){
        console.log("View",view);

        var viewpoint = new Viewpoint({
          targetGeometry: new Point({
            x: 644831,
            y: 7734548
          }),
          scale: 2000,
          heading: 20,
          tilt: 10,
        });

        var legend = new Legend({
          view: view
        });

        // Add widget to the bottom right corner of the view
        // view.ui.add(legend, "top-right");


        view.goTo(viewpoint);

        view.ui.add(locateWidget, "bottom-right");
        // view.ui.add(measureWidget, "top-right");
        // view.on("click",function(){
        //   console.log(view)
        // });
        // var test = view.activeTool
        // console.log(test)
        // var handle = test.watch("directDistance", function(nyVerdi,gmlVerdi,property,objekt){
        //   if(objekt.verticalDistance){console.log(objekt.horizontalDistance, objekt.verticalDistance)}
        //   console.log(objekt)
        // });

        // view.on("pointer-move",function(evt){
        //   var hoydeDiv = document.querySelector("#hoydeinfo");
        //   hoydeDiv.style.left = evt.x + 10+"px";
        //   hoydeDiv.style.top = evt.y + 10 +"px";
        //
        //   var pos = view.toMap({
        //     x:evt.x,
        //     y:evt.y
        //   });
        //   var hoyde = bakke.queryElevation(pos);
        //   hoyde.then(function(res){
        //     hoydeDiv.innerHTML = res.geometry.z.toFixed(0) + " moh";
        //   })
        // })

        function queryExtent(pos) {
          var extent =  {}
          extent.xmin = pos.x - 5
          extent.xmax = pos.x + 5
          extent.ymin = pos.y - 5
          extent.ymax  = pos.y + 5
          return extent
        }


        function copyToClipboard(text) {
          window.prompt("x,y,z koordinat\nSRID: 25833\n\nKopier tekst: Ctrl+C, Enter", text);
        }

        function queryOptions(){
          var options = {
            query: {
              where: 'skredtype in (130,131,132,133,134,135,136,137,138,139)',
              geometry:'{xmin: ' + view.extent.xmin + ', ymin: ' + view.extent.ymin + ', xmax: ' + view.extent.xmax + ', ymax: ' + view.extent.ymax + '}',
              geometryType: 'esriGeometryEnvelope',
              inSR:28533,
              spatialRel: 'esriSpatialRelIntersects',
              outFields: 'skredType, skredNavn, stedsnavn, skredTidspunkt, noySkredTidspunkt, persBerort, annetSkadet, redningsaksjon, vaerObservasjon, totAntPersOmkommet, ansvarligInstitusjon, beskrivelse, objektType, registrertDato, utlosningArsak, dokumentasjon',
              // outFields: '*',
              returnGeometry:true,
              returnTrueCurves:false,
              outSR:25833,
              returnIdsOnly:false,
              returnCountOnly:false,
              returnZ:false,
              returnM:false,
              returnDistinctValues:false,
              returnExtentsOnly:false,
              f: 'geojson',
            },
            responseType: 'json'
          };
        return options
        }

        view.on('click', function(evt) {
          var hoydeDiv = document.querySelector("#hoydeinfo");

          var pos = view.toMap({
            x:evt.x,
            y:evt.y
          });

          var url = 'https://wms3.nve.no/map/rest/services/SkredHendelser/MapServer/1/query?'
          esriRequest(url, queryOptions()).then(function(response) {
            console.log('response', response)
            var item = response.data.features["0"]
            console.log(item.geometry.coordinates["0"], item.geometry.coordinates["1"], item.properties);
            var grafikk = new Graphic({
              geometry: new Point({
                  x: item.geometry.coordinates["0"],
                  y: item.geometry.coordinates["1"],
                }),
              symbol: { type: "simple-marker" },
              attributes: item.properties
            })
            view.graphics.add(grafikk)
          })

          var hoyde = bakke.queryElevation(pos)
          console.log('HÃ¸yde',hoyde)
          hoyde.then(function(res){
            hoydeDiv.innerHTML = 'x: ' + pos.x.toFixed(0) + ' <br />y: ' + pos.y.toFixed(0) + ' <br />moh: ' + res.geometry.z.toFixed(0)
            copyToClipboard(pos.x.toFixed(0) + ', ' + pos.y.toFixed(0) + ', ' + res.geometry.z.toFixed(0))
          })
        })
      })
    })
  </script>
</head>
<body>
  <div id="viewDiv">
    <div id="hoydeinfo">Hoyde</div>

    </div>
</body>
</html>
